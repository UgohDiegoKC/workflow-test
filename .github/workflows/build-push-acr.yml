name: Build and Push to ACR

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**/*.md'
      - '.gitignore'
      - '.dockerignore'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Custom tag for the image'
        required: false
        type: string

env:
  ACR_NAME: workflowtest
  IMAGE_NAME: workflow-test-app
  AZURE_RESOURCE_GROUP: workflowtest-rg

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
    
      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Generate image tags
        id: meta
        run: |
          # Get short commit SHA
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          # Determine tags based on branch/event
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
            TAGS="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:pr-${PR_NUMBER}-${SHORT_SHA}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            TAGS="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:main-${SHORT_SHA}"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            TAGS="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:develop ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:develop-${SHORT_SHA}"
          else
            BRANCH_NAME=$(echo ${{ github.ref }} | sed 's/refs\/heads\///' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')
            TAGS="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${BRANCH_NAME}-${SHORT_SHA}"
          fi
          
          # Add custom tag if provided via workflow_dispatch
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAGS="${TAGS} ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.event.inputs.tag }}"
          fi
          
          # Add version tag if package.json version exists
          VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "")
          if [ -n "$VERSION" ] && [ "$VERSION" != "0.0.0" ]; then
            TAGS="${TAGS} ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:v${VERSION}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "Generated tags: ${TAGS}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max
          platforms: linux/amd64

      - name: Image digest
        run: |
          echo "Image pushed with tags: ${{ steps.meta.outputs.tags }}"
